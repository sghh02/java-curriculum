# 制作物：ToDo管理（コンソール版）をDB（JDBC）対応する

この章は、Unit 6（データベースアクセス）までに学んだJDBCを、制作物に適用するチェックポイントです。

## ゴール

- メモリ上のToDoを、RDBに保存できる
- SQLとJavaの境界を意識してCRUDを実装できる

## 前提

- 接続先のDBやJDBCドライバの準備は、`データベースアクセス` の章で行った手順をそのまま使ってください（H2を想定）
- 前章までの「コンソール版ToDo（ArrayList＋例外＋日時）」が動いていること

## この章での方針

DB対応をしたいとき、UI（CLI）やサービス（ロジック）にSQLが混ざると、後から直すのが大変になります。
そこで「保存先」だけを差し替えられるように、`TaskRepository` インタフェースを用意します。

```text
TodoCli  →  TodoService  →  TaskRepository
                          ├─ InMemoryTaskRepository（メモリ）
                          └─ JdbcTaskRepository（DB）
```

## テーブル設計（例）

DBは任意でOKです。次のような構造になるようにテーブルを作成してください。

```sql
CREATE TABLE TASKS (
  ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  TITLE VARCHAR(100) NOT NULL,
  COMPLETED BOOLEAN NOT NULL,
  CREATED_AT TIMESTAMP NOT NULL,
  UPDATED_AT TIMESTAMP NOT NULL
);
```

※DBによって `AUTO_INCREMENT` や `BOOLEAN` の扱いが異なる場合があります。自分のDBに合わせて調整してください。

## 実装例（動く最小）

### `TaskRepository.java`

```java
package com.example.todo;

import java.util.List;

public interface TaskRepository {
    List<Task> findAll();

    Task findById(long id); // 見つからない場合は null

    Task insert(Task task);

    Task update(Task task);

    boolean deleteById(long id);
}
```

### `InMemoryTaskRepository.java`（メモリ実装）

```java
package com.example.todo;

import java.util.ArrayList;
import java.util.List;

public class InMemoryTaskRepository implements TaskRepository {
    private final List<Task> tasks = new ArrayList<>();
    private long nextId = 1;

    @Override
    public List<Task> findAll() {
        return new ArrayList<>(tasks);
    }

    @Override
    public Task findById(long id) {
        for (Task task : tasks) {
            if (task.getId() != null && task.getId() == id) {
                return task;
            }
        }
        return null;
    }

    @Override
    public Task insert(Task task) {
        task.setId(nextId);
        nextId++;
        tasks.add(task);
        return task;
    }

    @Override
    public Task update(Task task) {
        return task;
    }

    @Override
    public boolean deleteById(long id) {
        for (int i = 0; i < tasks.size(); i++) {
            if (tasks.get(i).getId() != null && tasks.get(i).getId() == id) {
                tasks.remove(i);
                return true;
            }
        }
        return false;
    }
}
```

### `JdbcTaskRepository.java`（DB実装）

H2の例です。`JDBC_URL` は `データベースアクセス` の章と同じ値にしてください。

```java
package com.example.todo;

import java.sql.*;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

public class JdbcTaskRepository implements TaskRepository {
    private final String jdbcUrl;
    private final String user;
    private final String password;

    public JdbcTaskRepository(String jdbcUrl, String user, String password) {
        this.jdbcUrl = jdbcUrl;
        this.user = user;
        this.password = password;
    }

    @Override
    public List<Task> findAll() {
        String sql = "SELECT ID, TITLE, COMPLETED, CREATED_AT, UPDATED_AT FROM TASKS ORDER BY ID";
        try (Connection conn = getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql);
             ResultSet rs = stmt.executeQuery()) {
            List<Task> result = new ArrayList<>();
            while (rs.next()) {
                result.add(map(rs));
            }
            return result;
        } catch (SQLException e) {
            throw new RuntimeException("DB error: findAll", e);
        }
    }

    @Override
    public Task findById(long id) {
        String sql = "SELECT ID, TITLE, COMPLETED, CREATED_AT, UPDATED_AT FROM TASKS WHERE ID = ?";
        try (Connection conn = getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            stmt.setLong(1, id);
            try (ResultSet rs = stmt.executeQuery()) {
                if (!rs.next()) {
                    return null;
                }
                return map(rs);
            }
        } catch (SQLException e) {
            throw new RuntimeException("DB error: findById id=" + id, e);
        }
    }

    @Override
    public Task insert(Task task) {
        String sql = "INSERT INTO TASKS (TITLE, COMPLETED, CREATED_AT, UPDATED_AT) VALUES (?, ?, ?, ?)";
        try (Connection conn = getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {
            stmt.setString(1, task.getTitle());
            stmt.setBoolean(2, task.isDone());
            stmt.setTimestamp(3, Timestamp.valueOf(task.getCreatedAt()));
            stmt.setTimestamp(4, Timestamp.valueOf(task.getUpdatedAt()));
            stmt.executeUpdate();

            try (ResultSet keys = stmt.getGeneratedKeys()) {
                if (keys.next()) {
                    task.setId(keys.getLong(1));
                }
            }
            return task;
        } catch (SQLException e) {
            throw new RuntimeException("DB error: insert", e);
        }
    }

    @Override
    public Task update(Task task) {
        String sql = "UPDATE TASKS SET TITLE = ?, COMPLETED = ?, UPDATED_AT = ? WHERE ID = ?";
        try (Connection conn = getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            stmt.setString(1, task.getTitle());
            stmt.setBoolean(2, task.isDone());
            stmt.setTimestamp(3, Timestamp.valueOf(task.getUpdatedAt()));
            stmt.setLong(4, task.getId());
            stmt.executeUpdate();
            return task;
        } catch (SQLException e) {
            throw new RuntimeException("DB error: update id=" + task.getId(), e);
        }
    }

    @Override
    public boolean deleteById(long id) {
        String sql = "DELETE FROM TASKS WHERE ID = ?";
        try (Connection conn = getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            stmt.setLong(1, id);
            int count = stmt.executeUpdate();
            return count == 1;
        } catch (SQLException e) {
            throw new RuntimeException("DB error: deleteById id=" + id, e);
        }
    }

    private Connection getConnection() throws SQLException {
        return DriverManager.getConnection(jdbcUrl, user, password);
    }

    private Task map(ResultSet rs) throws SQLException {
        Task task = new Task();
        task.setId(rs.getLong("ID"));
        task.setTitle(rs.getString("TITLE"));
        task.setDone(rs.getBoolean("COMPLETED"));
        task.setCreatedAt(toLocalDateTime(rs.getTimestamp("CREATED_AT")));
        task.setUpdatedAt(toLocalDateTime(rs.getTimestamp("UPDATED_AT")));
        return task;
    }

    private LocalDateTime toLocalDateTime(Timestamp ts) {
        return ts == null ? null : ts.toLocalDateTime();
    }
}
```

### `TodoService.java`（Repositoryを使うように変更）

`TodoService` は「保存先」を知らないようにして、`TaskRepository` だけに依存させます。

```java
package com.example.todo;

import java.util.List;

public class TodoService {
    private final TaskRepository taskRepository;

    public TodoService(TaskRepository taskRepository) {
        this.taskRepository = taskRepository;
    }

    public Task add(String title) {
        if (title == null || title.trim().isEmpty()) {
            throw new InvalidTaskTitleException();
        }
        Task task = new Task(title.trim());
        return taskRepository.insert(task);
    }

    public List<Task> list() {
        return taskRepository.findAll();
    }

    public Task done(long id) {
        Task task = taskRepository.findById(id);
        if (task == null) {
            throw new TaskNotFoundException(id);
        }
        task.setDone(true);
        task.touch();
        return taskRepository.update(task);
    }

    public void delete(long id) {
        boolean deleted = taskRepository.deleteById(id);
        if (!deleted) {
            throw new TaskNotFoundException(id);
        }
    }
}
```

### `Main.java`（DB実装に差し替える）

```java
package com.example.todo;

import java.util.Scanner;

public class Main {
    public static void main(String[] args) {
        TaskRepository repository = new JdbcTaskRepository(
                "jdbc:h2:~/rpgdb",
                "sa",
                ""
        );

        TodoService todoService = new TodoService(repository);
        Scanner scanner = new Scanner(System.in);

        TodoCli cli = new TodoCli(todoService, scanner);
        cli.run();
    }
}
```

## 練習問題

### 練習問題1：TaskRepositoryインタフェースを作る

保存先を差し替えられるように、次のようなインタフェースを用意してください（メソッド名は好みでOK）。

- `findAll()`
- `findById(...)`
- `insert(...)`
- `update(...)`
- `delete(...)`

### 練習問題2：JdbcTaskRepositoryを実装する

`TaskRepository` の実装として `JdbcTaskRepository` を作り、JDBCでCRUDを実装してください。

- `PreparedStatement` を使う（文字列連結でSQLを作らない）
- `try-with-resources` でクローズ漏れを防ぐ

### 練習問題3：TodoServiceをDB対応にする

`TodoService` が `JdbcTaskRepository` を使うように差し替えて、CLIで動作確認してください。

## 完了条件（チェックリスト）

- アプリを再起動してもToDoが残る（DBに保存されている）
- SQLインジェクションを防げている（`PreparedStatement`）
- 例外発生時に原因が追える（ログ/メッセージがある）

## AIに質問する（この章の例）

次の例をそのままAIに投げてOKです（必要なら自分のコード/エラーに置き換えてください）。

- 「『制作物：ToDo管理（コンソール版）をDB（JDBC）対応する』を初心者向けに、たとえ話つきで説明して。最後に要点を3つにまとめて」
- 「この章の内容で理解確認クイズを5問作って（解答は最後にまとめて）」
- 「自分の実装を貼るのでレビューして。バグ/設計の危険箇所だけ指摘して、直し方はヒントで」
- 「この章の内容を、制作物（ToDo管理）にどう活かすか提案して」
